---
title: "EDM_all_Spp_all_dams"
author: "Alison Iles"
date: "2/13/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# CORE_EDM research questions

Is there evidence of a (strong, consistent) negative impact on salmon returns of pinniped pop increases in the Columbia Basin?
If so, for which runs? Does this effect match local pred occupancy?
Does it depend on the run timing or sub-basin?
How are culls predicted to affect salmon returns and other components of system? 


```{r}
# loading R packages
library(rEDM) # All the EDM analyses are carried out by the rEDM package.
library(Kendall)

```

# Load and prepare data

```{r}

folder <- "/Users/alisoniles/Google Drive/Coordinated Recoveries/Data/analysis ready/FPC annual dam counts/"      # path to folder that holds multiple .csv files
file_list <- list.files(path=folder, pattern="*.csv") # create list of all .csv files in folder
dam_list <- substr(file_list,1,3) #create list of all dam names


# read in each .csv file in file_list and create a data frame with the same name as the .csv file
for (i in 1:length(file_list)){
  assign(substr(file_list[i],1,3), 
  read.csv(paste(folder, file_list[i], sep=''))
  )}

fish_list <- colnames(BON)[2:12] #create list of fish names
data.list <- list(BON, TDA, JDA, MCN, PRD, RIS, RRH, WEL, IHR, LMN, LGS, LGR) #put data into a list in order from mouth to headwaters (Columbia R followed by Snake R.). Don't include WFA or WAN as there is not enough years 
salmon <- lapply(data.list, function(x) x[(names(x) %in% c("year", "chinook", "coho", "steelhead", "sockeye", "chinook_SS", "chinook_F"))]) # Keep just the "Chinook" "Chinook SS" "Chinook F" "Coho" "Steelhead"  and  "Sockeye" columns

# Data normalization: Prior to simplex projection, the time series are normalized to zero mean and unit variance.
for (i in 1:length(salmon)){  #for each dam
    for (j in 2:7){ #for each species
      d <- salmon[[i]][[j]]   
      salmon[[i]][[j]] <- ((d-mean(d))/sd(d)) 
    }
}

# Load other variables: PDO, SRKW, sealion data
folder <- "/Users/alisoniles/Google Drive/Coordinated Recoveries/Data/analysis ready/"      # path to folder that holds .csv files
file_list <- list.files(path=folder, pattern="*.csv") # create list of all .csv files in folder

# read in each .csv file in file_list and create a data frame with the same name as the .csv file
for (i in 1:length(file_list)){
  assign(file_list[i], 
  read.csv(paste(folder, file_list[i], sep=''))
)}

PDO.csv$PDOya <- ((PDO.csv[,"PDOya"]-mean(PDO.csv[,"PDOya"]))/sd(PDO.csv[,"PDOya"]))
#plot(PDO.csv$PDOya~PDO.csv$Year,type="l",xlab="Year",ylab="PDO",ylim=c(-2,2),col=2,main="PDO time series")

SRKW.csv$SR_Orca <- ((SRKW.csv[,"SR_Orca"]-mean(SRKW.csv[,"SR_Orca"]))/sd(SRKW.csv[,"SR_Orca"]))

sealion.csv$Pup.count <- ((sealion.csv[,"Pup.count"]-mean(sealion.csv[,"Pup.count"]))/sd(sealion.csv[,"Pup.count"]))
sealion.csv$Male <- ((sealion.csv[,"Male"]-mean(sealion.csv[,"Male"]))/sd(sealion.csv[,"Male"]))

```
# Simplex projection (Sugihara & May 1990)

The complexity of a system can be practically defined as the number of independent variables needed to reconstruct the attractor (i.e. dimensionality of the system). Determining the best embedding dimension E with 'Simplex projection' is a fundamental first step in all EDM analysis. 

By simplex projection, we make one-step, out-of-sample forward forecast (predict t+1 step) using different values of E to determine the optimal embedding dimension. We present the results showing the relationship between the predictive skill (ρ - the correlation coefficient between observations and forecasts) and the embedding dimension (E) (Fig. 2c & d in the main text).

Note that, in the case where the time series is rather short, leave-one-out cross-validation can be performed instead of dividing the time series into halves (Sugihara et al. 1996; Glaser et al. 2014).

```{r}
# The simplex projection is carried out by the function rEDM::simplex(). 
# We divide the time series into two halves. The first half is used as the library set for manifold reconstruction. The second half is used as the target for out-of-sample prediction. 
# The argument lib is the time index indicating the start (1) and the end (n/2) in the library set, respectively. Similarly, the argument pred indicates the time index in the prediction set. 

# We specify a sequence of testing embedding dimensions from 2 to 8 by the argument E=c(2:8), which executes the simplex projections using different embedding dimensions.


E <- list()
for (i in 1:1){ #length(salmon)){  #for each dam
    for (j in 2:7){ #for each species
n <- round(length(salmon[[i]][[j]])/2)
sim <- simplex(salmon[[i]][[j]],lib=c(1,n),pred=c(n+1,length(salmon[[i]][[j]])),E=c(2:10)) #Salmon 
E[[j]] <-sim[which.max(sim),"E"][1]# The optimal E 
    }
}

sim_PDO <- simplex(PDO.csv$PDOya,lib=c(1,round(length(PDO.csv$PDOya)/2)),pred=c(round(length(PDO.csv$PDOya)/2)+1,length(PDO.csv$PDOya)),E=c(2:10)) # PDO
sim_orca <- simplex(SRKW.csv$SR_Orca,lib=c(1,round(length(SRKW.csv$SR_Orca)/2)),pred=c(round(length(SRKW.csv$SR_Orca)/2)+1,length(SRKW.csv$SR_Orca)),E=c(2:10)) # ORca
sim_sealionpup <- simplex(sealion.csv$Pup.count,lib=c(1,round(length(sealion.csv$Pup.count)/2)),pred=c(round(length(sealion.csv$Pup.count)/2)+1,length(sealion.csv$Pup.count)),E=c(2:10)) # Sealion pups
sim_sealionmale <- simplex(sealion.csv$Male,lib=c(1,round(length(sealion.csv$Male)/2)),pred=c(round(length(sealion.csv$Male)/2)+1,length(sealion.csv$Male)),E=c(2:10)) # Sealion Males

# We present the results showing the relationship between the predictive skill (ρ) and the embedding dimension (E)
## Plot predictive skill (rho) vs embedding dimension (E) 
#par(mfrow=c(1,1),mar=c(4,4,1,1))
#plot(rho~E,data=sim_FChnk,type="l",xlab="Embedding dimension (E)",ylab=expression(rho),ylim=c(-0.4,0.8),col=2,main="Ice Harbor Dam Fall Chinook, determine optimal E")

## The optimal embedding dimension determined by maximizing rho

E_PDO <-sim_PDO[which.max(sim_PDO$rho),"E"][1]# The optimal E of PDO
E_orca <-sim_orca[which.max(sim_orca$rho),"E"][1]# The optimal E of southern resident orca population
E_sealionpup <-sim_sealionpup[which.max(sim_sealionpup$rho),"E"][1]# The optimal E of sea lion pup count data
E_sealionmale <-sim_sealionmale[which.max(sim_sealionmale$rho),"E"][1]# The optimal E of  male sea lion population estimates
```




