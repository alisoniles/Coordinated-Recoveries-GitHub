---
title: "1_EDM_Preprocess_data"
author: "Alison Iles"
date: "6/27/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#load the necessary packages. 
Note that the `echo = FALSE` parameter prevents printing of the R code.

```{r, echo=FALSE}
library(rEDM)
library(reshape2)
library(ggplot2)
library(gridExtra)
library(xtable)
library(rlist)
library(tidyr)
```

#load Chinook stock data and harvest data
```{R}
data <- read.csv("Data/csv_data/CORE_2020_data_stock.csv")
```

#normalize

```{R}
 # To focus on one stock to figure out what's going on use
# stock_df <- subset(data, stk == "Wallow River, Hurricane Creek, Bear Creek, and Lostine Rivers") 
 

# This code normalizes by cycle line. Chinook don't demonstrate a strong cycle line, so it is set to '1', normalize on a 1 year cycle 
    normalize_by_cycle_line <- function(ts)
{
    n <- length(ts)
    means <- rep.int(NA, times = 4) #replicate NA 4 times
    sds <- rep.int(NA, times = 4)
    mu <- rep.int(NA, times = n)
    sigma <- rep.int(NA, times = n)
    for(k in 1:1) #for each cycle line (every 4 years the population cycles in sockeye, I've changed it to 1 because there are no cycle lines for chinook)
    {
        index <- seq(from = k, to = n, by = 1) #changed by=4 to b=1.
        means[k] <- mean(ts[index], na.rm = TRUE) #mean of every 4th element of the time series
        sds[k] <- sd(ts[index], na.rm = TRUE) #standard dev.
        mu[index] <- means[k]
        sigma[index] <- sds[k]
    }
    ts <- (ts - mu) / sigma  #normalize by cycle line
    df <- data.frame(cbind(ts, mu, sigma))
    return(df)
    }
    


     preprocess_stock <- function(stock_df)
    {
        n <- NROW(stock_df)  #n is the number of observations for the stock
         
        stock_df$ret <- stock_df$rec3 + c(NA, stock_df$rec4[1:(n-1)]) + c(NA, NA, stock_df$rec5[1:(n-2)]) #total returns in a given year are calculated by adding 3 year old recruits plus 4 year old recruits from the previous brood year, plus 5 year olds from two years prior...etc. This value is aligned to the rec3 brood year, not the year they are actually returning together. 
       
        # Normalize on a 1 year cycle line (i.e. NO cycle line!)
        temp <- normalize_by_cycle_line(stock_df$spawn_tot)
        stock_df$eff_n <- temp$ts #normalized number of effective spawners
        stock_df$eff_mu <- temp$mu
        stock_df$eff_sigma <- temp$sigma
        
        temp <- normalize_by_cycle_line(stock_df$rec3)
        stock_df$rec3_n <- temp$ts #normalized 3 year old recruits
        stock_df$rec3_mu <- temp$mu
        stock_df$rec3_sigma <- temp$sigma
        
        temp <- normalize_by_cycle_line(stock_df$rec4)
        stock_df$rec4_n <- temp$ts #normalized 4 year old recruits
        stock_df$rec4_mu <- temp$mu
        stock_df$rec4_sigma <- temp$sigma

        temp <- normalize_by_cycle_line(stock_df$rec5)
        stock_df$rec5_n <- temp$ts #normalized 5 year old recruits
        stock_df$rec5_mu <- temp$mu
        stock_df$rec5_sigma <- temp$sigma
        
        temp <- normalize_by_cycle_line(stock_df$rec)
        stock_df$rec_n <- temp$ts #normalized total recruits
        stock_df$rec_mu <- temp$mu
        stock_df$rec_sigma <- temp$sigma
        
        temp <- normalize_by_cycle_line(stock_df$ret)
        stock_df$ret_n <- temp$ts #normalized returns
        stock_df$ret_mu <- temp$mu
        stock_df$ret_sigma <- temp$sigma
        
        temp <- normalize_by_cycle_line(stock_df$harvest)
        stock_df$harv_n <- temp$ts #normalized returns
        stock_df$harv_mu <- temp$mu
        stock_df$harv_sigma <- temp$sigma
        
        return(stock_df)
    }   
     
     
     
stock_data <- split(data, data$stk)    
stock_data <- lapply(stock_data, preprocess_stock) 

```

#load large scale (ESU scale) environmental and species data and mid scale (MPG scale) river flow data

```{R}
env_data <- read.csv("Data/csv_data/SRSS_env_prelim.csv")
esu_data <- read.csv("Data/csv_data/CORE_2020_data_ESU.csv")
mpg_data <- read.csv("Data/csv_data/CORE_2020_data_MPG.csv")

# Change the peak flow date to day of year
startyrdate <- as.Date(paste(as.character(mpg_data$year),"-01-01",sep=""))
peakflowdate <- as.Date(mpg_data$flow.peakdate)
mpg_data$flow.peakday <- as.numeric(peakflowdate - startyrdate)
mpg_data$flow.peakdate <- NULL

# use this to focus on one stock to trouble-shoot the function code:
stock_df <- subset(data, stk == "Wallowa River, Hurricane Creek, Bear Creek, and Lostine Rivers") 


normalize <- function(block)
{
    if(NCOL(block) > 1)
    {
        n <- NROW(block)
        means <- sapply(block, mean, na.rm = TRUE)
        sds <- sapply(block, sd, na.rm = TRUE)
        return((block - matrix(rep(means, each = n), nrow = n)) / 
                   matrix(rep(sds, each = n), nrow = n))
    }
    else
        return((block - mean(block, na.rm = TRUE)) / sd(block, na.rm = TRUE))
}


make_block <- function(stock_df, env_data, esu_data)
    {
        env_names <- c("up48.jan",	"up48.feb",	"up48.mar",	"up48.apr",	"up48.may",	"up48.jun",	"up48.jul",	"up48.aug",	"up48.sep",	"up48.oct",	"up48.nov",	"up48.dec", "pdo.jan",  "pdo.feb", "pdo.mar",  "pdo.apr",  "pdo.may",  "pdo.jun",  "pdo.jul",  "pdo.aug",  "pdo.sep", "pdo.oct",    "pdo.nov", "pdo.dec", "pdo.win", "npgo.yr")  
        env_data[, 2:NCOL(env_data)] <- normalize(env_data[2:NCOL(env_data)]) 
        
        hatch_names <- c("hatch.spring", "hatch.summer", "hatch.total")
        hatch_data <- normalize(esu_data[, hatch_names]) 
        
        pinn_names <- c("pinn.CSLbonn", "pinn.CSLhaulout", "pinn.CSLmales", "pinn.HSaerial", "pinn.HSbonn", "pinn.SSLaerial", "pinn.SSLbonn", "pinn.SSLrookORraw", "pinn.TOTbonn")
        pinn_data <- normalize(esu_data[, pinn_names]) 
        
        CSL_pups_data <- normalize(esu_data[, "pinn.CSLpup"])
        
        smelt_names <- c("smelt.CPUE", "smelt.ssb")
        smelt_data <- normalize(esu_data[, smelt_names]) 
        
        SRKW_names <- c( "SRKW.Jpod", "SRKW.Kpod", "SRKW.Lpod", "SRKW.KLpods", "SRKW.JKLpods", "SRKW.JKLdeaths", "SRKW.JKLbirths")
        SRKW_data <- normalize(esu_data[, SRKW_names]) 
        
        
        
        
        # line up environmental data at ESU level
        # offset environmental data from 2 to 5 years after brood year. 
        for(i in 2:5) { 
              desired_years <- stock_df$year + i
              index_in_env_data <- match(desired_years, env_data$year)
              index_in_stock_df <- 1:length(desired_years)
        
              df <- data.frame(matrix(NA, nrow = length(desired_years), ncol = NCOL(env_data)-1))
              df[index_in_stock_df,] <- env_data[index_in_env_data, 2:NCOL(env_data)]
              df.colnames <- paste(env_names, i, sep = ".")
              stock_df[, df.colnames] <- df
        }
        
           
        
        # line up species data at ESU level
      
        # offset hatchery data from 1 to 5 years after brood year - assuming the hatchery releases age 2 smolts and they compete with the naturally spawned smolts starting at age 2
        for(i in 1:5) { 
              desired_years <- stock_df$year + i
              index_in_spp_data <- match(desired_years, esu_data$year)
              index_in_stock_df <- 1:length(desired_years)
              df <- data.frame(matrix(NA, nrow = length(desired_years), ncol = NCOL(hatch_data)))
              df[index_in_stock_df,] <- hatch_data[index_in_spp_data, ]
              df.colnames <- paste(hatch_names, i, sep = ".")
              stock_df[, df.colnames] <- df
        }
        
        # offset pinniped data from 2, 4 and 5 years after brood year - assuming sea lions eat smolts and returns
        for(i in c(2,4,5)) { 
              desired_years <- stock_df$year + i
              index_in_spp_data <- match(desired_years, esu_data$year)
              index_in_stock_df <- 1:length(desired_years)
              df <- data.frame(matrix(NA, nrow = length(desired_years), ncol = NCOL(pinn_data)))
              df[index_in_stock_df,] <- pinn_data[index_in_spp_data, ]
              df.colnames <- paste(pinn_names, i, sep = ".")
              stock_df[, df.colnames] <- df
        }
  
        # offset CA sealion pup data from 2, 4 and 5 years after brood year. Add 3 years to each as only 3+ year old sea lion males swim up to Oregon
        for(i in c(5,7,8)) { 
              desired_years <- stock_df$year + i
              index_in_spp_data <- match(desired_years, esu_data$year)
              index_in_stock_df <- 1:length(desired_years)
              df <- data.frame(matrix(NA, nrow = length(desired_years), ncol = NCOL(CSL_pups_data)))
              df[index_in_stock_df,] <- CSL_pups_data[index_in_spp_data ]
              df.colnames <- paste("pinn.CSLpup", (i-3), sep = ".")
              stock_df[, df.colnames] <- df
        }
        
        # offset smelt data by return year (4,5)
        for(i in 4:5) { 
              desired_years <- stock_df$year + i
              index_in_spp_data <- match(desired_years, esu_data$year)
              index_in_stock_df <- 1:length(desired_years)
              df <- data.frame(matrix(NA, nrow = length(desired_years), ncol = NCOL(smelt_data)))
              df[index_in_stock_df,] <- smelt_data[index_in_spp_data, ]
              df.colnames <- paste(smelt_names, i, sep = ".")
              stock_df[, df.colnames] <- df
        }
        # line up orca data
        for(i in 4:5) { # offset orca data from 4 to 5 years after brood year - assuming orcas just eat the returning fish
              desired_years <- stock_df$year + i
              index_in_spp_data <- match(desired_years, esu_data$year)
              index_in_stock_df <- 1:length(desired_years)
                     
              df <- data.frame(matrix(NA, nrow = length(desired_years), ncol = NCOL(SRKW_data)))
              df[index_in_stock_df,] <- SRKW_data[index_in_spp_data, ]
              df.colnames <- paste(SRKW_names, i, sep = ".")
              stock_df[, df.colnames] <- df
        }
        
        
        
        
        # line up river flow data at MPG level
        desired_mpg <- as.character(stock_df$mpg[[1]])
        mpg_tempdata <- mpg_data[mpg_data$mpg==desired_mpg,]
        mpg_tempdata$mpg <- NULL
        mpgdata_names <- c("flow.mean", "flow.peak", "flow.gageht", "flow.peakday")
        mpg_tempdata[, 2:NCOL(mpg_tempdata)] <- normalize(mpg_tempdata[, mpgdata_names]) 
        
        for (i in 0:5) {
              desired_years <- stock_df$year + i
              index_in_mpg_data <- match(desired_years, mpg_tempdata$year)
              index_in_stock_df <- 1:length(desired_years)
              
              df <- data.frame(matrix(NA, nrow = length(desired_years), ncol = NCOL(mpg_tempdata)-1))
              df[index_in_stock_df,] <- mpg_tempdata[index_in_mpg_data, 2:NCOL(mpg_tempdata)]
              df.colnames <- paste(mpgdata_names, i, sep = ".")
              stock_df[, df.colnames] <- df
        }
        
        
        return(stock_df)
    }



block_data <- lapply(stock_data, function(stock_df) {make_block(stock_df, env_data, esu_data)})


    
# save and return
    save(block_data, file = "Data/Rdata/block_data.Rdata")

```


