---
title: "4_Vis_IS_rec5"
author: "Kurt Ingeman"
date: "6/27/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}

rm(list = ls())

library(here)
library(tidyr)
library(dplyr)
library(ggplot2)
library(fmsb)
library(forcats)
library(RColorBrewer)
library(kableExtra)

```

```{r, include=FALSE}
load(here("CORE EDM analysis", "Output", "Rdata", "4_IS", "SMAP_best_embeddings_ESU_rec5n.RData")) 
rec5_ESU <- out_results
rm(out_results)

load(here("CORE EDM analysis", "Output", "Rdata", "4_IS", "SMAP_best_embeddings_Imnaha_rec5n.RData")) 
rec5_IMN <- out_results
rm(out_results)

load(here("CORE EDM analysis", "Output", "Rdata", "4_IS", "SMAP_best_embeddings_Middle Fork Salmon_rec5n.RData")) 
rec5_MFS <- out_results
rm(out_results)

load(here("CORE EDM analysis", "Output", "Rdata", "4_IS", "SMAP_best_embeddings_Upper Salmon_rec5n.RData")) 
rec5_UPS <- out_results
rm(out_results)

```

## create domains (Ocean, Human, Predator)
```{r, include=FALSE}

rec5_ESU<-  rec5_ESU %>% 
  mutate(domain = case_when(
    grepl("npgo", FP) ~ "ocean",
    grepl("pdo", FP) ~ "ocean",
    grepl("arc", FP) ~ "ocean",
    grepl("upw", FP) ~ "ocean", 
    grepl("hatch", FP) ~ "human",
    grepl("harv", FP) ~ "human",
    grepl("hseal", FP) ~ "pred",
    grepl("orca", FP) ~ "pred",
    grepl("csl", FP) ~ "pred", 
    grepl("ssl", FP) ~ "pred", 
    TRUE ~"other"))


rec5_IMN<-  rec5_IMN %>% 
  mutate(domain = case_when(
    grepl("npgo", FP) ~ "ocean",
    grepl("pdo", FP) ~ "ocean",
    grepl("arc", FP) ~ "ocean",
    grepl("upw", FP) ~ "ocean", 
    grepl("hatch", FP) ~ "human",
    grepl("harv", FP) ~ "human",
    grepl("hseal", FP) ~ "pred",
    grepl("orca", FP) ~ "pred",
    grepl("csl", FP) ~ "pred", 
    grepl("ssl", FP) ~ "pred", 
    TRUE ~"other"))

rec5_MFS <-  rec5_MFS %>% 
  mutate(domain = case_when(
    grepl("npgo", FP) ~ "ocean",
    grepl("pdo", FP) ~ "ocean",
    grepl("arc", FP) ~ "ocean",
    grepl("upw", FP) ~ "ocean", 
    grepl("hatch", FP) ~ "human",
    grepl("harv", FP) ~ "human",
    grepl("hseal", FP) ~ "pred",
    grepl("orca", FP) ~ "pred",
    grepl("csl", FP) ~ "pred", 
    grepl("ssl", FP) ~ "pred", 
    TRUE ~"other"))

rec5_UPS <-  rec5_UPS %>% 
  mutate(domain = case_when(
    grepl("npgo", FP) ~ "ocean",
    grepl("pdo", FP) ~ "ocean",
    grepl("arc", FP) ~ "ocean",
    grepl("upw", FP) ~ "ocean", 
    grepl("hatch", FP) ~ "human",
    grepl("harv", FP) ~ "human",
    grepl("hseal", FP) ~ "pred",
    grepl("orca", FP) ~ "pred",
    grepl("csl", FP) ~ "pred", 
    grepl("ssl", FP) ~ "pred", 
    TRUE ~"other"))



```

# ESU 

# 2a. What variables are in the top models? In what frequency?
### To do that right, we need to actually through ALL the vars in the SMAP hopper, not just the top ones
### But I can get an highest and average rank model that each var shows up in


```{r, include=FALSE}
 
unique(rec5_ESU$FP)  
emb_num_rec5 <- as.numeric(length(unique(rec5_ESU$embedding))) 

rec5_mods <- rec5_ESU %>%
  group_by(embedding, FP) %>% 
  summarise() %>% 
  group_by(FP) %>% 
  mutate(
    best_mod = min(embedding), # lowest number (highest rank) model
    scale_mod = 1 / best_mod, # above expressed as 0-1
    rank_mod = mean(embedding)/emb_num_rec5 , # average rank of model that that they are in
    total_num = length(embedding), # number of models that they are in
    prop_mod = total_num/emb_num_rec5, # proportion of model that they are in 
    weight = emb_num_rec5-embedding, # reverse of rank
    integrated = sum(weight)/(emb_num_rec5*(emb_num_rec5 + 1) / 2)) %>% # integrate rank and weight 
  slice(1) %>% 
  filter(!grepl("rec5", FP)) %>% 
  arrange(prop_mod) %>% 
  ungroup()


# organize vars by Ocean, People, Biol

rec5_mods$FP


```
```{r}

rec5_spider <- data.frame(rbind(rep(1,8), rep(0,8), 
                              rec5_mods$rank_mod, rec5_mods$prop_mod, rec5_mods$scale_mod 
                                ))
colnames(rec5_spider) <- rec5_mods$FP

trans.pal <- c("#7BCAE44D", "#E47BCA4D", "#CAE47B4D")
pal <- c("#7BCAE4", "#E47BCA", "#CAE47B")

# op <- par(mar = c(1, 1, 1, 1))
# par(mar = c(1, 0, 1, 5))

radarchart(rec5_spider, axistype=0,
           #custom polygon
           pcol=pal, pfcol=trans.pal,  plwd=2, plty=1, seg = 3,
           #custom the grid
           cglcol="grey", cglty=1, cglwd=0.8,
           #custom labels
           vlcex=.9, vlabels = c("Harvest", "CSL", "ARC", "NPGO", "PDO", "Hatchery", "Upwelling", "HSL"), 
           title="What variables are found in top models?")

# legend(x=.9, y=.8, legend = c("Ave Rank", "No. Models", "Highest Rank"), bty = "n", pch=20 , col=pal, text.col = "grey", cex=1, pt.cex=2)


# par(op)



```


# 2b. How do predator interaction strengths compared to variables from other domains (ocean, human)?
### Distribution of partial derivatives, averaged across stocks, and across years, for each var

```{r}


rec5_ESU <-  rec5_ESU %>% 
  filter(!grepl("rec5", FP)) %>% 
  group_by(FP) %>% 
  mutate(mu = mean(value, na.rm=TRUE)) %>%
  ungroup()

ggplot(rec5_ESU, aes(x = FP, y = value)) + 
  geom_violin()

ggplot(rec5_ESU, aes(x = value, color = FP, fill = FP)) +
  geom_density(alpha = 0.4) +
  geom_vline(aes(xintercept = mu, color = FP),
             linetype = "dashed")

# Tough to see differences in this style
unique(rec5_ESU$FP)
rec5_ESU$FP = factor(rec5_ESU$FP, levels=c("pdo.spr.3", "harv.stock.0", 'hatch.spring.3', 'hseal.COL.5', 'arc.win.2', 'upw.lusi.5', 'npgo.yravg.2', "csl.Dpups.-3"))

ggplot(rec5_ESU, aes(x = value, color = FP, fill = FP)) +
  geom_histogram(position = "identity", alpha = 0.4) +
  scale_color_manual(values = colorRampPalette(brewer.pal(9, "Blues"))(8)[2:9]) +
  scale_fill_manual(values = colorRampPalette(brewer.pal(9, "Blues"))(8)[2:9]) +
    geom_vline(aes(xintercept = mu, color = FP),
             linetype = "dashed")+ 
  facet_grid(FP ~ .)

ggplot(rec5_ESU, aes(x = value, color = FP, fill = FP)) +
  geom_density(alpha = 0.4) +
  scale_color_manual(values = colorRampPalette(brewer.pal(9, "Blues"))(8)[2:9]) +
  scale_fill_manual(values = colorRampPalette(brewer.pal(9, "Blues"))(8)[2:9]) +
    geom_vline(aes(xintercept = mu, color = FP),
             linetype = "dashed")+ 
  facet_grid(FP ~ .)

```

# 3. How do predator interaction strengths (and vars from other domains) vary through time?
### Times series of partial Derivatives, averaged across stocks, for each var 

```{r}
ggplot(rec5_ESU, aes(x = year, y = value, fill = FP, color = FP)) +
  geom_smooth() +
  scale_fill_manual(values = colorRampPalette(brewer.pal(9, "Blues"))(8)[2:9]) +
  scale_color_manual(values = colorRampPalette(brewer.pal(9, "Blues"))(8)[2:9]) +
    geom_hline(aes(yintercept = 0),
             linetype = "dashed") + 
  facet_grid(FP ~ .)

rec5_ESU_ts <- rec5_ESU %>% 
  filter(year > 1957) %>%
  filter(year < 2016) %>% 
  mutate(year = factor(year)) %>% 
  group_by(year, FP) %>% 
  summarise(IS = mean(value, na.rm = TRUE), 
            sd = sd(value, na.rm = TRUE),
            n = n()) %>%
  mutate(se = sd / sqrt(n),
         lower = IS - qt(1 - (0.05 / 2), n - 1) * se,
         upper = IS + qt(1 - (0.05 / 2), n - 1) * se) %>% 
  mutate(year = as.integer(year)) %>% 
ungroup() %>% ungroup() 
  
ggplot(rec5_ESU_ts, aes(x = year, color = FP, fill = FP)) +
  geom_line(aes(y = IS)) +
  geom_line(aes(y = upper), alpha = 0.5) +
  geom_line(aes(y = lower), alpha = 0.5) +
  geom_hline(aes(yintercept = 0),
             linetype = "dashed") +
    scale_fill_manual(values = colorRampPalette(brewer.pal(9, "Blues"))(8)[2:9]) +
  scale_color_manual(values = colorRampPalette(brewer.pal(9, "Blues"))(8)[2:9]) +
     facet_grid(FP ~ .)
 
```

```{r}
rec5_ESU_lines <- rec5_ESU %>% 
  filter(year > 1957) %>%
  filter(year < 2016) %>% 
  mutate(year = factor(year)) %>% 
  group_by(year, FP, embedding) %>% 
  mutate(IS = mean(value)) %>% 
  mutate(year = as.integer(year))


ggplot() +
  geom_line(rec5_ESU_lines, mapping = aes(x=year, y=IS, col=FP, group=embedding)) +    
  geom_hline(rec5_ESU_lines, mapping = aes(yintercept = 0),linetype = "dashed", color = "red") +
  scale_fill_manual(values = colorRampPalette(brewer.pal(9, "Blues"))(8)[2:9]) +
  scale_color_manual(values = colorRampPalette(brewer.pal(9, "Blues"))(8)[2:9]) +
  geom_line(rec5_ESU_ts, mapping = aes(x=year, y=IS), color = "black") +
  facet_grid(FP ~ ., scales = "free") +
  theme_bw()

```



#######
# IMN # 
#######

# 2a. What variables are in the top models? In what frequency?

```{r}
 
unique(rec5_IMN$FP)  

unique(rec5_IMN$embedding) # 178

em_rec5_IMN <- as.numeric(length(unique(rec5_IMN$embedding))) 

rec5_mods <- rec5_IMN %>%
  group_by(embedding, FP) %>% 
  summarise() %>% 
  group_by(FP) %>% 
  mutate(
    best_mod = min(embedding), # lowest number (highest rank) model
    scale_mod = 1 / best_mod, # above expressed as 0-1
    rank_mod = mean(embedding)/em_rec5_IMN , # average rank of model that that they are in
    total_num = length(embedding), # number of models that they are in
    prop_mod = total_num/em_rec5_IMN , # proportion of model that they are in 
    weight = em_rec5_IMN -embedding, # reverse of rank
    integrated = sum(weight)/(em_rec5_IMN *(em_rec5_IMN+1) /2)) %>% # integrate rank and weight 
  slice(1) %>% 
  filter(!grepl("rec5", FP)) %>% 
  ungroup()

vars_IMN <- unique(rec5_mods$FP)

# Make a table instead

rec5_table <- rec5_mods %>% 
  select(FP, best_mod, prop_mod, rank_mod)

rec5_table %>%
  kbl() %>%
  kable_classic_2(full_width = F)


```


# 2b. How do predator interaction strengths compared to variables from other domains (ocean, human)?
### Distribution of partial derivatives, averaged across stocks, and across years, for each var

```{r}
rec5_IMN<-  rec5_IMN  %>% 
  filter(!grepl("rec5", FP)) %>% 
  group_by(FP) %>% 
  mutate(mu = mean(value, na.rm=TRUE)) %>%
  ungroup()

ggplot(rec5_IMN, aes(x = FP, y = value)) + 
  geom_violin()

rec5_IMN$domain = factor(rec5_IMN$domain, levels = c( "ocean" , "pred", "human"))


rec5_IMN$FP = factor(rec5_IMN$FP, 
                levels=c("pdo.sum.2",
                         'upw.tumi.2',
                         'flow.peak.3',
                        'orca.SRKWdeathsJKL.5', 
                         "npgo.yrsum.2",
                          "hatch.total.3",
                        "arc.sum.2", 
                        "hseal.COL.5", 
                       "harv.ORWAsport.5"
                        ))

ggplot(rec5_IMN, aes(x = value, color = domain, fill = domain)) +
  geom_density(alpha = 0.4) +
  scale_color_manual(values = pal) +
  scale_fill_manual(values = pal) +
    geom_vline(aes(xintercept = mu, color = domain),
             linetype = "dashed") + 
  facet_grid(FP ~ .)
```

# 3. How do predator interaction strengths (and vars from other domains) vary through time?
### Times series of partial Derivatives, averaged across stocks, for each var 
```{r, include=FALSE}
ggplot(rec5_IMN, aes(x = year, y = value, fill = domain, color = domain)) +
  geom_smooth() +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
    geom_hline(aes(yintercept = 0),
             linetype = "dashed") + 
  facet_grid(FP ~ ., scales = "free")
```

```{r}

rec5_IMN_ts <- rec5_IMN %>% 
  filter(year > 1957) %>%
  filter(year < 2016) %>% 
  mutate(year = factor(year)) %>% 
  group_by(year, FP) %>% 
  mutate(IS = mean(value, na.rm = TRUE), 
            sd = sd(value, na.rm = TRUE),
            n = n()) %>% 
  mutate(se = sd / sqrt(n),
         lower = IS - qt(1 - (0.05 / 2), n - 1) * se,
         upper = IS + qt(1 - (0.05 / 2), n - 1) * se) %>% 
  mutate(year = as.integer(year))
  
ggplot(rec5_IMN_ts, aes(x = year, color = domain, fill = domain)) +
  geom_line(aes(y = IS)) +
  geom_line(aes(y = upper), alpha = 0.5) +
  geom_line(aes(y = lower), alpha = 0.5) +
  geom_hline(aes(yintercept = 0),
             linetype = "dashed") +
    scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
     facet_wrap(~ FP + domain, scales = "free")
 
```

```{r}
rec5_IMN_lines <- rec5_IMN %>% 
  filter(year > 1957) %>%
  filter(year < 2016) %>% 
  mutate(year = factor(year)) %>% 
  group_by(year, FP, embedding) %>% 
  mutate(IS = mean(value)) %>% 
  mutate(year = as.integer(year))


ggplot() +
  geom_line(rec5_IMN_lines, mapping = aes(x=year, y=IS, col=domain, group=embedding)) + 
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_hline(rec5_IMN_lines, mapping = aes(yintercept = 0),linetype = "dashed", color = "red") +
  geom_line(rec5_IMN_ts, mapping = aes(x=year, y=IS), color = "black") +
  facet_wrap(FP + domain ~ ., scales = "free") +
  theme_bw()

```


#######
# MFS # 
#######


```{r}
 
unique(rec5_MFS$FP)  

unique(rec5_MFS$embedding) # 89

em_rec5_MFS <- as.numeric(length(unique(rec5_MFS$embedding))) 

rec5_mods <- rec5_MFS %>%
  group_by(embedding, FP) %>% 
  summarise() %>% 
  group_by(FP) %>% 
  mutate(
    best_mod = min(embedding), # lowest number (highest rank) model
    scale_mod = 1 / best_mod, # above expressed as 0-1
    rank_mod = mean(embedding)/em_rec5_MFS , # average rank of model that that they are in
    total_num = length(embedding), # number of models that they are in
    prop_mod = total_num/em_rec5_MFS , # proportion of model that they are in 
    weight = em_rec5_MFS -embedding, # reverse of rank
    integrated = sum(weight)/(em_rec5_MFS *(em_rec5_MFS+1) /2)) %>% # integrate rank and weight 
  slice(1) %>% 
  filter(!grepl("rec5", FP)) %>% 
  ungroup()

vars_MFS <- unique(rec5_mods$FP)

# Make a table instead

rec5_table <- rec5_mods %>% 
  select(FP, best_mod, prop_mod, rank_mod)

rec5_table %>%
  kbl() %>%
  kable_classic_2(full_width = F)

```

# 2b. How do predator interaction strengths compared to variables from other domains (ocean, human)?

### Partial Derivatives, averaged across stocks, and across years, for each 


```{r}
rec5_MFS<-  rec5_MFS  %>% 
  filter(!grepl("rec5", FP)) %>% 
  group_by(FP) %>% 
  mutate(mu = mean(value, na.rm=TRUE)) %>%
  arrange(mu) %>% 
  ungroup()

vars_MFS <- rec5_MFS %>% 
  arrange(mu) %>% 
  select(FP) %>% 
  unique()

ggplot(rec5_MFS, aes(x = fct_reorder(FP, value), y = value)) + 
  geom_violin()

rec5_MFS$domain = factor(rec5_MFS$domain, levels = c( "ocean", "pred", "human"))

rec5_MFS$FP <- fct_reorder(rec5_MFS$FP, rec5_MFS$mu, min)


ggplot(rec5_MFS, aes(x = year, y = value, fill = domain, color = domain)) +
  geom_smooth() +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
    geom_hline(aes(yintercept = 0),
             linetype = "dashed") + 
  facet_grid(FP ~ ., scales = "free")

# distribution

ggplot(rec5_MFS, aes(x = value, color = domain, fill = domain)) +
  geom_density(alpha = 0.4) +
  scale_color_manual(values = pal) +
  scale_fill_manual(values = pal) +
    geom_vline(aes(xintercept = mu, color = domain),
             linetype = "dashed") + 
  facet_grid(FP ~ .)

```
# 3. How do predator interaction strengths (and vars from other domains) vary through time?
### Times series of partial Derivatives, averaged across stocks, for each var 

```{r}

rec5_MFS_ts <- rec5_MFS %>% 
  filter(year > 1957) %>%
  filter(year < 2016) %>% 
  mutate(year = factor(year)) %>% 
  group_by(year, FP) %>% 
  mutate(IS = mean(value, na.rm = TRUE), 
            sd = sd(value, na.rm = TRUE),
            n = n()) %>% 
  mutate(se = sd / sqrt(n),
         lower = IS - qt(1 - (0.05 / 2), n - 1) * se,
         upper = IS + qt(1 - (0.05 / 2), n - 1) * se) %>% 
  mutate(year = as.integer(year))
  
ggplot(rec5_MFS_ts, aes(x = year, color = domain, fill = domain)) +
  geom_line(aes(y = IS)) +
  geom_line(aes(y = upper), alpha = 0.5) +
  geom_line(aes(y = lower), alpha = 0.5) +
  geom_hline(aes(yintercept = 0),
             linetype = "dashed") +
    scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
     facet_wrap(~ FP + domain, scales = "free")
 
```

```{r}
rec5_MFS_lines <- rec5_MFS %>% 
  filter(year > 1957) %>%
  filter(year < 2016) %>% 
  mutate(year = factor(year)) %>% 
  group_by(year, FP, embedding) %>% 
  mutate(IS = mean(value)) %>% 
  mutate(year = as.integer(year))


ggplot() +
  geom_line(rec5_MFS_lines, mapping = aes(x=year, y=IS, col=domain, group=embedding)) + 
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_hline(rec5_MFS_lines, mapping = aes(yintercept = 0),linetype = "dashed", color = "red") +
  geom_line(rec5_MFS_ts, mapping = aes(x=year, y=IS), color = "black") +
  facet_wrap(FP + domain ~ ., scales = "free") +
  theme_bw()

```


#######
# UPS # 
#######

# 2a. What variables are in the top models? In what frequency?
### To do that right, we need to actually through ALL the vars in the SMAP hopper, not just the top ones
### But I can get an highest and average rank model that each var shows up in


```{r}
 
unique(rec5_UPS$FP)  

unique(rec5_UPS$embedding) # 36

em_rec5_UPS <- as.numeric(length(unique(rec5_UPS$embedding))) 

rec5_mods_UPS <- rec5_UPS %>%
  group_by(embedding, FP) %>% 
  summarise() %>% 
  group_by(FP) %>% 
  mutate(
    best_mod = min(embedding), # lowest number (highest rank) model
    scale_mod = 1 / best_mod, # above expressed as 0-1
    rank_mod = mean(embedding)/em_rec5_UPS , # average rank of model that that they are in
    total_num = length(embedding), # number of models that they are in
    prop_mod = total_num/em_rec5_UPS , # proportion of model that they are in 
    weight = em_rec5_UPS -embedding, # reverse of rank
    integrated = sum(weight)/(em_rec5_UPS *(em_rec5_UPS+1) /2)) %>% # integrate rank and weight 
  slice(1) %>% 
  filter(!grepl("rec5", FP)) %>% 
  ungroup()


# Make a table instead

rec5_table_UPS <- rec5_mods_UPS %>% 
  select(FP, best_mod, prop_mod, rank_mod)

rec5_table_UPS %>%
  kbl() %>%
  kable_classic_2(full_width = F)


```


# 2b. How do predator interaction strengths compared to variables from other domains (ocean, human)?

### Partial Derivatives, averaged across stocks, and across years, for each 


```{r}
rec5_UPS<-  rec5_UPS  %>% 
  filter(!grepl("rec5", FP)) %>% 
  filter(!grepl("flow", FP)) %>% 
  group_by(FP) %>% 
  mutate(mu = mean(value, na.rm=TRUE)) %>%
  ungroup()

ggplot(rec5_UPS, aes(x = fct_reorder(FP, value), y = value)) + 
  geom_violin()

rec5_UPS$FP <- fct_reorder(rec5_UPS$FP, rec5_UPS$mu, min)

ggplot(rec5_UPS, aes(x = value, color = domain, fill = domain)) +
  geom_density(alpha = 0.4) +
  scale_color_manual(values = pal) +
  scale_fill_manual(values = pal) +
    geom_vline(aes(xintercept = mu, color = domain),
             linetype = "dashed") + 
  facet_grid(FP ~ .)


```

# 3. How do predator interaction strengths (and vars from other domains) vary through time?
### Times series of partial Derivatives, averaged across stocks, for each var 

```{r}

ggplot(rec5_UPS, aes(x = year, y = value, fill = domain, color = domain)) +
  geom_smooth() +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
    geom_hline(aes(yintercept = 0),
             linetype = "dashed") + 
  facet_grid(FP ~ ., scales = "free")

rec5_UPS_ts <- rec5_UPS %>% 
  filter(year > 1957) %>%
  filter(year < 2016) %>% 
  mutate(year = factor(year)) %>% 
  group_by(year, FP) %>% 
  mutate(IS = mean(value, na.rm = TRUE), 
            sd = sd(value, na.rm = TRUE),
            n = n()) %>% 
  mutate(se = sd / sqrt(n),
         lower = IS - qt(1 - (0.05 / 2), n - 1) * se,
         upper = IS + qt(1 - (0.05 / 2), n - 1) * se) %>% 
  mutate(year = as.integer(year))
  
ggplot(rec5_UPS_ts, aes(x = year, color = domain, fill = domain)) +
  geom_line(aes(y = IS)) +
  geom_line(aes(y = upper), alpha = 0.5) +
  geom_line(aes(y = lower), alpha = 0.5) +
  geom_hline(aes(yintercept = 0),
             linetype = "dashed") +
    scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
     facet_wrap(~ FP + domain, scales = "free")
 
```

```{r}
rec5_UPS_lines <- rec5_UPS %>% 
  filter(year > 1957) %>%
  filter(year < 2016) %>% 
  mutate(year = factor(year)) %>% 
  group_by(year, FP, embedding) %>% 
  mutate(IS = mean(value)) %>% 
  mutate(year = as.integer(year))


ggplot() +
  geom_line(rec5_UPS_lines, mapping = aes(x=year, y=IS, col=domain, group=embedding)) + 
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_hline(rec5_UPS_lines, mapping = aes(yintercept = 0),linetype = "dashed", color = "red") +
  geom_line(rec5_UPS_ts, mapping = aes(x=year, y=IS), color = "black") +
  facet_wrap(FP + domain ~ ., scales = "free") +
  theme_bw()

```


# Fin